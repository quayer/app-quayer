// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ORGANIZATIONS & USERS (Multi-tenancy)
// ============================================

model Organization {
  id           String  @id @default(uuid())
  name         String
  slug         String  @unique
  document     String  @unique // CPF ou CNPJ
  type         String // "pf" ou "pj"
  maxInstances Int     @default(1)
  maxUsers     Int     @default(1)
  billingType  String  @default("free") // free, basic, pro
  isActive     Boolean @default(true)

  // Business hours configuration
  businessHoursStart String? // Format: "09:00"
  businessHoursEnd   String? // Format: "18:00"
  businessDays       String? // Format: "1,2,3,4,5" (Segunda a Sexta)
  timezone           String  @default("America/Sao_Paulo")

  // Session & Automation Settings
  sessionTimeoutHours  Int     @default(24) // 1-72 horas para encerrar sessão inativa
  notificationsEnabled Boolean @default(true)
  balancedDistribution Boolean @default(true) // Distribuir sessões entre agentes
  typingIndicator      Boolean @default(true) // Mostrar "digitando..."
  profanityFilter      Boolean @default(false) // Filtrar palavrões
  autoGreeting         Boolean @default(false) // Saudação automática
  greetingMessage      String? // Mensagem de saudação

  // Auto-Pause Hybrid Model (quando atendente assume)
  autoPauseBehavior        AutoPauseBehavior @default(WAIT_CUSTOMER) // O que fazer quando auto-pause expira
  autoPauseWaitMinutes     Int               @default(30) // Minutos para aguardar cliente (se WAIT_CUSTOMER)
  autoPauseDurationMinutes Int               @default(15) // Duração padrão do auto-pause

  // Group Chat Settings
  groupDefaultMode    GroupMode           @default(DISABLED) // Modo padrão para novos grupos
  groupAiResponseMode GroupAIResponseMode @default(PRIVATE) // Modo de resposta IA padrão

  // White-label Branding
  logoUrl        String? // URL do logo customizado
  primaryColor   String  @default("#000000") // Cor primária da marca
  secondaryColor String? // Cor secundária
  supportEmail   String? // Email de suporte personalizado
  customDomain   String? // Domínio customizado

  // Provider Configuration (Quayer Managed vs Own UAZapi)
  providerType String  @default("quayer") // "quayer" (managed) or "uazapi" (own)
  uazapiUrl    String? // URL da API UAZapi personalizada
  uazapiKey    String? // Chave de API UAZapi (encriptada)

  // SMTP Configuration
  smtpConfig Json? // { host, port, user, pass, from }

  // BYOC (Bring Your Own Credentials) Flags
  useOwnOpenAI   Boolean @default(false) // Usar própria API key OpenAI
  useOwnRedis    Boolean @default(false) // Usar próprio Redis
  useOwnDatabase Boolean @default(false) // Usar próprio PostgreSQL
  useOwnStorage  Boolean @default(false) // Usar próprio S3/Storage

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users        UserOrganization[]
  connections  Connection[]
  projects     Project[]
  webhooks     Webhook[]
  auditLogs    AuditLog[]
  chatSessions ChatSession[]
  calls        Call[]
  providers    OrganizationProvider[]

  @@index([document])
  @@index([slug])
  @@index([billingType])
}

model UserOrganization {
  id             String   @id @default(uuid())
  userId         String
  organizationId String
  role           String // master, manager, user
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
  @@index([role])
}

model User {
  id               String    @id @default(uuid())
  email            String    @unique
  password         String
  name             String
  emailVerified    DateTime?
  currentOrgId     String? // Org ativa no momento
  role             String    @default("user") // admin (sistema), user
  isActive         Boolean   @default(true)
  resetToken       String? // Token para recuperação de senha
  resetTokenExpiry DateTime? // Expiração do token de recuperação

  // Onboarding and organization management
  onboardingCompleted Boolean @default(false)
  lastOrganizationId  String?

  // Message signature and AI preferences
  messageSignature     Json?   @db.JsonB // { enabled, format, department, customText, showPreview }
  aiSuggestionsEnabled Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sessions            Session[]
  refreshTokens       RefreshToken[]
  invitations         Invitation[]         @relation("InvitedBy")
  organizations       UserOrganization[]
  auditLogs           AuditLog[]
  verificationCodes   VerificationCode[]
  contactObservations ContactObservation[]
  files               File[]
  calls               Call[]
  assignedConnections Connection[]         @relation("AssignedCustomer")

  passkeyCredentials PasskeyCredential[]

  @@index([email])
  @@index([currentOrgId])
  @@index([role])
  @@index([resetToken])
}

// ============================================
// PASSKEY / WEBAUTHN CREDENTIALS
// ============================================

model PasskeyCredential {
  id                   String   @id @default(uuid())
  userId               String
  credentialId         String   @unique // Base64URL encoded credential ID
  publicKey            Bytes // COSE public key
  counter              BigInt   @default(0) // Signature counter for clone detection
  credentialDeviceType String   @default("singleDevice") // singleDevice or multiDevice
  credentialBackedUp   Boolean  @default(false)
  transports           String[] // Transports supported by authenticator (usb, ble, nfc, internal)

  // User-friendly name for the passkey
  name String @default("Minha Passkey")

  // AAGUID for device identification (optional)
  aaguid String?

  createdAt  DateTime  @default(now())
  lastUsedAt DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([credentialId])
  @@index([lastUsedAt])
}

// Temporary challenge for WebAuthn operations
model PasskeyChallenge {
  id        String   @id @default(uuid())
  challenge String   @unique // Base64URL encoded challenge
  userId    String? // Optional for registration (user not yet authenticated)
  email     String? // For login without userId
  type      String // "registration" or "authentication"
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([challenge])
  @@index([userId])
  @@index([email])
  @@index([expiresAt])
}

// Temporary user for signup (before email verification)
model TempUser {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@index([code])
  @@index([expiresAt])
}

// Verification codes (OTP, Magic Link, etc)
model VerificationCode {
  id        String   @id @default(uuid())
  userId    String?
  email     String
  code      String
  type      String // OTP, MAGIC_LINK, RESET_PASSWORD, EMAIL_VERIFICATION
  token     String? // For magic links (JWT token)
  used      Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email, type])
  @@index([code])
  @@index([token])
  @@index([expiresAt])
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model RefreshToken {
  id        String    @id @default(uuid())
  userId    String
  token     String    @unique
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model Invitation {
  id             String    @id @default(uuid())
  email          String
  token          String    @unique @default(uuid())
  role           String    @default("user")
  organizationId String
  invitedById    String
  usedAt         DateTime?
  expiresAt      DateTime
  createdAt      DateTime  @default(now())

  invitedBy User @relation("InvitedBy", fields: [invitedById], references: [id])

  @@index([invitedById])
  @@index([organizationId])
  @@index([token])
  @@index([expiresAt])
}

// ============================================
// DEPARTMENTS (Hierarchical Organization)
// ============================================

model Department {
  id             String   @id @default(uuid())
  organizationId String
  name           String
  slug           String
  description    String?
  type           String   @default("support") // support, sales, custom
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  chatSessions ChatSession[]

  @@unique([organizationId, slug])
  @@index([organizationId])
  @@index([slug])
  @@index([type])
  @@index([isActive])
}

// ============================================
// PROJECTS & INSTANCES
// ============================================

model Project {
  id             String   @id @default(uuid())
  name           String
  description    String?
  organizationId String
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  connections  Connection[]

  @@index([organizationId])
}

// ============================================
// CONNECTIONS (WhatsApp/Instagram/Telegram Integrations)
// ============================================

model Connection {
  id   String @id @default(uuid())
  name String

  // Channel & Provider
  channel  Channel  @default(WHATSAPP)
  provider Provider @default(WHATSAPP_WEB)

  // Connection Status
  status            ConnectionStatus @default(DISCONNECTED)
  phoneNumber       String?
  profileName       String?
  profilePictureUrl String?
  isBusiness        Boolean          @default(false)

  // uazapi Integration
  uazapiInstanceId     String?   @unique // ID na uazapi
  uazapiToken          String? // Token encriptado da instância
  qrCode               String?   @db.Text
  pairingCode          String?
  lastConnected        DateTime?
  lastDisconnect       DateTime?
  lastDisconnectReason String?

  // WhatsApp Cloud API Integration (Official Meta API)
  cloudApiAccessToken   String? @map("cloud_api_access_token") @db.Text // System User Token (pode ser longo)
  cloudApiPhoneNumberId String? @map("cloud_api_phone_number_id") // Phone Number ID do Meta Business
  cloudApiWabaId        String? @map("cloud_api_waba_id") // WhatsApp Business Account ID
  cloudApiVerifiedName  String? @map("cloud_api_verified_name") // Nome verificado da conta business

  // n8n Integration (AI Agent)
  n8nWebhookUrl  String? // URL do workflow n8n
  n8nWorkflowId  String? // ID do workflow
  n8nFallbackUrl String? // URL de fallback
  agentConfig    Json? // { prompt, tools, model, temperature }

  // Organization & Project
  organizationId String? // Nullable para permitir instâncias sem organização (admin)
  projectId      String?

  // Customer Assignment (Admin only)
  assignedCustomerId String? // ID do cliente/usuário atribuído pelo admin

  // Message Delay Config
  msgDelayMin Int @default(2)
  msgDelayMax Int @default(4)

  // Share Token System
  shareToken               String?   @unique
  shareTokenExpiresAt      DateTime?
  shareTokenExtensionCount Int       @default(0) // Max 3 extensions allowed

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization           Organization?           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project                Project?                @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignedCustomer       User?                   @relation("AssignedCustomer", fields: [assignedCustomerId], references: [id], onDelete: SetNull)
  webhooks               Webhook[]
  chatSessions           ChatSession[]
  messages               Message[]
  tabulationIntegrations TabulationIntegration[]
  calls                  Call[]
  n8nCallLogs            N8nCallLog[]
  groupChats             GroupChat[]

  // Advanced Settings
  settings ConnectionSettings?

  // Connection Events History
  events ConnectionEvent[]

  @@index([organizationId])
  @@index([projectId])
  @@index([status])
  @@index([channel])
  @@index([provider])
  @@index([uazapiInstanceId])
  @@index([cloudApiPhoneNumberId])
  @@index([shareToken])
  @@index([n8nWorkflowId])
  @@map("connections")
}

// ============================================
// CONNECTION SETTINGS (Advanced Configuration per Instance)
// ============================================

model ConnectionSettings {
  id           String @id @default(uuid())
  connectionId String @unique

  // ===== CONCATENAÇÃO DE MENSAGENS =====
  concatEnabled     Boolean @default(true)
  concatTimeoutMs   Int     @default(8000) // 8 segundos
  concatMaxMessages Int     @default(10)
  concatSameType    Boolean @default(false) // false = concat tudo junto (melhor para IA)
  concatSameSender  Boolean @default(true) // apenas mesmo remetente

  // ===== TRANSCRIÇÃO & IA =====
  transcriptionEnabled      Boolean @default(true)
  imageDescriptionEnabled   Boolean @default(true)
  documentAnalysisEnabled   Boolean @default(true)
  videoTranscriptionEnabled Boolean @default(true)

  // ===== GEOCODING =====
  geocodingEnabled Boolean @default(true)
  geocodingApiKey  String? // Se vazio, usa da organização ou sistema

  // ===== AI MODELS (override do padrão) =====
  transcriptionModel String? // whisper-1
  visionModel        String? // gpt-4o
  analysisModel      String? // gpt-4o

  // ===== AI PROMPTS (override do padrão) =====
  imagePrompt    String? @db.Text
  audioPrompt    String? @db.Text
  documentPrompt String? @db.Text
  videoPrompt    String? @db.Text

  // ===== WHATSAPP 24H WINDOW =====
  enforceWhatsAppWindow   Boolean @default(true)
  templateFallbackEnabled Boolean @default(false)

  // ===== BOT ECHO DETECTION =====
  botEchoEnabled Boolean @default(true)
  botSignature   String? // Custom signature (default: \u200B\u200C\u200D)

  // ===== AUTO-PAUSE =====
  autoPauseOnHumanReply  Boolean @default(true)
  autoPauseDurationHours Int     @default(24)

  // ===== COMANDOS VIA CHAT =====
  commandsEnabled Boolean @default(true)
  commandPrefix   String  @default("@") // @fechar, @pausar

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  connection Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@index([connectionId])
  @@map("connection_settings")
}

enum Channel {
  WHATSAPP
  INSTAGRAM
  TELEGRAM
  EMAIL
}

enum Provider {
  WHATSAPP_WEB
  WHATSAPP_CLOUD_API
  WHATSAPP_BUSINESS_API
  INSTAGRAM_META
  TELEGRAM_BOT
  EMAIL_SMTP
}

enum ConnectionStatus {
  CONNECTED
  CONNECTING
  DISCONNECTED
  ERROR
}

// ============================================
// CONNECTION EVENTS (Connection/Disconnection History)
// ============================================

model ConnectionEvent {
  id           String @id @default(uuid())
  connectionId String

  // Event Info
  eventType  ConnectionEventType
  fromStatus ConnectionStatus?
  toStatus   ConnectionStatus

  // Context
  reason    String? // Reason for disconnection/error
  metadata  Json? // Additional context (qr_timeout, manual, etc)
  ipAddress String? // IP where event originated
  userAgent String? // Browser/Device info

  // User who triggered (if manual action)
  triggeredBy String? // User ID if manual

  // Timestamps
  createdAt DateTime @default(now())

  connection Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@index([connectionId])
  @@index([eventType])
  @@index([createdAt])
  @@map("connection_events")
}

enum ConnectionEventType {
  CONNECTED // Successfully connected
  DISCONNECTED // Disconnected (manual or automatic)
  CONNECTION_LOST // Unexpected disconnection
  QR_GENERATED // QR Code generated for pairing
  QR_SCANNED // QR Code was scanned
  QR_TIMEOUT // QR Code expired without scan
  QR_RETRY // Automatic QR retry triggered
  ERROR // Connection error occurred
  RECONNECTING // Attempting to reconnect
}

// ============================================
// N8N CALL LOGS (Monitoring & Audit)
// ============================================

model N8nCallLog {
  id           String @id @default(uuid())
  connectionId String

  // Request Info
  url     String
  payload Json

  // Response Info
  success    Boolean
  statusCode Int?
  response   Json?
  error      String? @db.Text

  // Performance
  latency Int // Milliseconds

  createdAt DateTime @default(now())

  connection Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@index([connectionId])
  @@index([success])
  @@index([createdAt])
  @@map("n8n_call_logs")
}

// ============================================
// WEBHOOKS & AUDIT LOGS
// ============================================

model Webhook {
  id             String   @id @default(uuid())
  url            String
  events         String[] // ["connection.created", "message.received", etc]
  description    String?
  secret         String? // HMAC secret for signature verification
  isActive       Boolean  @default(true)
  connectionId   String?
  organizationId String?

  // Filtros avançados (inspirado em UAZ API)
  excludeMessages     Boolean  @default(false) // Excluir mensagens do webhook
  addUrlEvents        Boolean  @default(false) // Adicionar eventos específicos na URL
  addUrlTypesMessages String[] @default([]) // Tipos de mensagem na URL: ["text", "image", "audio"]
  pathParams          Json? // Path parameters dinâmicos {"{userId}": "123"}

  // Retry configuration
  maxRetries Int @default(3)
  retryDelay Int @default(5000) // milliseconds
  timeout    Int @default(30000) // milliseconds

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  connection   Connection?       @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  organization Organization?     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  deliveries   WebhookDelivery[]

  @@index([connectionId])
  @@index([organizationId])
  @@index([isActive])
}

model WebhookDelivery {
  id          String    @id @default(uuid())
  webhookId   String
  event       String
  payload     Json
  response    Json?
  status      String    @default("pending") // pending, success, failure
  attempts    Int       @default(0)
  createdAt   DateTime  @default(now())
  completedAt DateTime?

  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([status])
  @@index([createdAt])
}

model AuditLog {
  id             String   @id @default(uuid())
  action         String // create, update, delete, login, etc
  resource       String // organization, instance, user, etc
  resourceId     String?
  userId         String
  organizationId String?
  metadata       Json?
  ipAddress      String?
  createdAt      DateTime @default(now())

  user         User          @relation(fields: [userId], references: [id])
  organization Organization? @relation(fields: [organizationId], references: [id])

  @@index([userId])
  @@index([organizationId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
}

// ============================================
// ACCESS LEVELS & PERMISSIONS (Sistema Dinâmico)
// ============================================

// Define recursos e ações disponíveis no sistema
model PermissionResource {
  id          String   @id @default(uuid())
  resource    String   @unique // organizations, users, connections, messages, etc
  displayName String // Nome amigável
  description String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  permissions RolePermission[]

  @@index([resource])
  @@index([isActive])
  @@map("permission_resources")
}

// Mapeia permissões por role
model RolePermission {
  id         String   @id @default(uuid())
  resourceId String
  role       String // admin, master, manager, agent, viewer
  actions    String[] // create, read, update, delete, manage, export, etc

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  resource PermissionResource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@unique([resourceId, role])
  @@index([role])
  @@index([resourceId])
  @@map("role_permissions")
}

// Access Levels customizados por organização
model AccessLevel {
  id             String   @id @default(uuid())
  name           String // "Custom Manager", "Limited User", etc
  permissions    Json // { "instances": ["create", "read"], "users": ["read"] }
  organizationId String? // null = global/system level
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([organizationId])
  @@index([isActive])
}

// ============================================
// CHAT SESSIONS & MESSAGES (WhatsApp Conversations)
// ============================================

model Contact {
  id            String  @id @default(uuid())
  phoneNumber   String  @unique
  name          String?
  email         String? // ❌ ADDED: Contact email
  profilePicUrl String?

  // WhatsApp Info
  isBusiness   Boolean @default(false)
  verifiedName String?

  // Organization & Source
  organizationId String? // ❌ ADDED: Organization link
  source         String? // ❌ ADDED: Integration/Instance ID que originou o contato
  externalId     String? // ❌ ADDED: ID externo (ex: CRM ID)
  bypassBots     Boolean @default(false) // ❌ ADDED: Bypass AI/Bots for this contact

  // Metadata
  tags         String[] @default([])
  customFields Json?

  // Custom Fields (inspired by UAZapi/Chatwoot fieldMap)
  contactField01 String? @db.VarChar(255)
  contactField02 String? @db.VarChar(255)
  contactField03 String? @db.VarChar(255)
  contactField04 String? @db.VarChar(255)
  contactField05 String? @db.VarChar(255)
  contactField06 String? @db.VarChar(255)
  contactField07 String? @db.VarChar(255)
  contactField08 String? @db.VarChar(255)
  contactField09 String? @db.VarChar(255)
  contactField10 String? @db.VarChar(255)
  contactField11 String? @db.VarChar(255)
  contactField12 String? @db.VarChar(255)
  contactField13 String? @db.VarChar(255)
  contactField14 String? @db.VarChar(255)
  contactField15 String? @db.VarChar(255)
  contactField16 String? @db.VarChar(255)
  contactField17 String? @db.VarChar(255)
  contactField18 String? @db.VarChar(255)
  contactField19 String? @db.VarChar(255)
  contactField20 String? @db.VarChar(255)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  chatSessions        ChatSession[]
  messages            Message[]
  contactTabulations  ContactTabulation[] // ❌ ADDED: Tabulations relation
  contactAttributes   ContactAttribute[] // Contact-specific attribute values
  contactObservations ContactObservation[]
  calls               Call[]
  groupParticipations GroupParticipant[] // Participações em grupos

  @@index([phoneNumber])
  @@index([name])
  @@index([organizationId])
  @@index([source])
  @@index([externalId])
}

model ChatSession {
  id             String @id @default(uuid())
  contactId      String
  connectionId   String
  organizationId String

  // Status
  status       SessionStatus    @default(QUEUED)
  startedBy    SessionStartedBy @default(CUSTOMER)
  statusReason String?
  endReason    String?
  externalId   String?

  // Assignment
  assignedDepartmentId String?
  assignedAgentId      String?
  assignedCustomerId   String?

  // IA Control
  aiEnabled      Boolean   @default(true)
  aiBlockedUntil DateTime?
  aiBlockReason  String?

  // AI Agent Configuration (qual agente IA está atendendo)
  aiAgentConfigId String? // FK para AIAgentConfig
  aiAgentId       String? // ID do agente IA ativo (pode ser de sistema externo)
  aiAgentName     String? // Nome do agente IA
  aiAgentTarget   String? // Target/objetivo do agente (ex: "vendas", "suporte")
  aiAgentBehavior String? // Comportamento específico do agente
  aiAgentContext  Json? // Contexto adicional do agente

  // Customer Journey Tracking
  customerJourney       String?   @default("new") // new, returning, qualified, etc
  journeyStage          String? // Estágio atual na jornada
  journeyUpdatedAt      DateTime? // Última atualização da jornada
  leadScore             Int? // Score do lead (0-100)
  conversionProbability Float? // Probabilidade de conversão (0-1)

  // Session Analytics
  totalMessages      Int   @default(0)
  totalAiMessages    Int   @default(0)
  totalAgentMessages Int   @default(0)
  totalMediaMessages Int   @default(0)
  avgResponseTime    Int? // Tempo médio de resposta em segundos
  sessionDuration    Int? // Duração total em segundos
  totalAiCost        Float @default(0) // Custo total de IA da sessão

  // Timing & Expiration
  lastMessageAt       DateTime  @default(now())
  lastMessageAuthorId String? // ID of user who sent last message (for signature logic)
  expiresAt           DateTime? // Calculated expiration based on org timeout
  pausedUntil         DateTime? // For @pausar command with time limit
  pausedBy            String? // Who paused: "command", "agent", "system"

  // WhatsApp 24h Window (compliance with WhatsApp Business API)
  lastCustomerMessageAt   DateTime? // Last message FROM customer (inbound)
  whatsappWindowExpiresAt DateTime? // 24h from last customer message
  whatsappWindowType      String?   @default("CUSTOMER_INITIATED") // CUSTOMER_INITIATED, BUSINESS_INITIATED

  // Concatenação
  isConcat      Boolean @default(false)
  concatTimeout Int     @default(8)

  // Metadata
  tags         String[] @default([])
  customFields Json?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  closedAt  DateTime?

  // Relacionamentos
  contact            Contact             @relation(fields: [contactId], references: [id], onDelete: Cascade)
  connection         Connection          @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  organization       Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  department         Department?         @relation(fields: [assignedDepartmentId], references: [id], onDelete: SetNull)
  aiAgentConfig      AIAgentConfig?      @relation(fields: [aiAgentConfigId], references: [id], onDelete: SetNull)
  messages           Message[]
  sessionTabulations SessionTabulation[]
  groupParticipants  GroupParticipant[] // Participantes de grupo vinculados a esta sessão

  @@index([contactId])
  @@index([connectionId])
  @@index([organizationId])
  @@index([status])
  @@index([aiBlockedUntil])
  @@index([lastMessageAt])
  @@index([expiresAt])
  @@index([pausedUntil])
  @@index([whatsappWindowExpiresAt])
  @@index([assignedDepartmentId])
  @@index([assignedAgentId])
  @@index([externalId])
  @@index([aiAgentConfigId])
  @@index([customerJourney])
}

enum SessionStatus {
  QUEUED // Aguardando atendimento
  ACTIVE // Em atendimento
  PAUSED // Pausada (aguardando resposta)
  CLOSED // Encerrada
}

enum SessionStartedBy {
  CUSTOMER // Iniciada pelo cliente
  BUSINESS // Iniciada pela empresa
  AGENT // Iniciada por agente
}

// ============================================
// AUTO-PAUSE BEHAVIOR (Hybrid Model)
// ============================================

enum AutoPauseBehavior {
  CLOSE_SESSION // Encerra sessão imediatamente quando auto-pause expira
  WAIT_CUSTOMER // Aguarda cliente por X minutos, depois fecha
}

// ============================================
// GROUP CHAT (WhatsApp Groups Support)
// ============================================

enum GroupMode {
  DISABLED // Bot não processa mensagens do grupo
  MONITOR_ONLY // Bot escuta mas não responde (analytics, coleta de leads)
  ACTIVE // Bot escuta e pode responder
}

enum GroupAIResponseMode {
  IN_GROUP // IA responde diretamente no grupo
  PRIVATE // IA responde no privado do participante
  HYBRID // IA decide baseado no contexto
}

model GroupChat {
  id             String @id @default(uuid())
  groupJid       String @unique // ID do grupo WhatsApp (ex: 5552199998888-123456@g.us)
  connectionId   String
  organizationId String

  // Group Info (synced from WhatsApp)
  name        String?
  description String?
  pictureUrl  String?
  ownerJid    String? // JID do dono do grupo
  createdAtWa DateTime? // Data de criação no WhatsApp

  // Configuration
  mode            GroupMode           @default(DISABLED)
  aiEnabled       Boolean             @default(false)
  aiResponseMode  GroupAIResponseMode @default(PRIVATE)
  aiAgentConfigId String? // Qual agente IA usa neste grupo

  // Session (grupos não expiram como contatos individuais)
  sessionStatus SessionStatus @default(ACTIVE)

  // Analytics
  totalMessages     Int       @default(0)
  totalParticipants Int       @default(0)
  lastMessageAt     DateTime?
  lastSyncAt        DateTime?

  // Metadata
  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  connection    Connection         @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  aiAgentConfig AIAgentConfig?     @relation(fields: [aiAgentConfigId], references: [id], onDelete: SetNull)
  participants  GroupParticipant[]
  messages      GroupMessage[]

  @@index([connectionId])
  @@index([organizationId])
  @@index([mode])
  @@index([sessionStatus])
  @@index([lastMessageAt])
  @@map("group_chats")
}

model GroupParticipant {
  id             String @id @default(uuid())
  groupId        String
  participantJid String // Número do participante (ex: 5552199998888@s.whatsapp.net)

  // Link com contato existente (se houver)
  contactId String?

  // Sessão privada vinculada (para responder no privado)
  privateSessionId String?

  // Role no grupo
  role String @default("participant") // admin, superadmin, participant

  // Tracking
  lastMessageAt DateTime?
  messageCount  Int       @default(0)
  joinedAt      DateTime?
  leftAt        DateTime?

  // Status
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  group          GroupChat    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  contact        Contact?     @relation(fields: [contactId], references: [id], onDelete: SetNull)
  privateSession ChatSession? @relation(fields: [privateSessionId], references: [id], onDelete: SetNull)

  @@unique([groupId, participantJid])
  @@index([groupId])
  @@index([contactId])
  @@index([participantJid])
  @@index([isActive])
  @@map("group_participants")
}

model GroupMessage {
  id             String @id @default(uuid())
  groupId        String
  participantJid String // Quem enviou a mensagem

  // Message Info
  waMessageId String      @unique
  type        MessageType
  content     String      @db.Text

  // Media (se aplicável)
  mediaUrl  String?
  mediaType String?
  mimeType  String?
  fileName  String?

  // AI Response (se bot respondeu)
  isAiResponse Boolean @default(false)
  aiModel      String?
  aiCost       Float?

  createdAt DateTime @default(now())

  // Relations
  group GroupChat @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([groupId])
  @@index([participantJid])
  @@index([waMessageId])
  @@index([createdAt])
  @@map("group_messages")
}

model Message {
  id           String @id @default(uuid())
  sessionId    String
  contactId    String
  connectionId String

  // Mensagem
  waMessageId String           @unique
  direction   MessageDirection
  type        MessageType
  author      MessageAuthor    @default(CUSTOMER)
  content     String           @db.Text

  // Conteúdo Formatado/Raw (para tracking de transformações)
  rawContent       String? @db.Text // Conteúdo original antes de sanitização
  formattedContent String? @db.Text // Conteúdo formatado/processado

  // Mídia
  mediaUrl      String?
  mediaType     String?
  mimeType      String?
  fileName      String?
  mediaSize     Int?
  mediaDuration Int?

  // Location Data (quando type = 'location')
  latitude     Float?
  longitude    Float?
  locationName String? // Nome do local enviado pelo usuário

  // Geocoded Address (preenchido automaticamente via Google Maps API)
  geoAddress      String? // Endereço completo formatado
  geoNeighborhood String? // Bairro
  geoCity         String? // Cidade
  geoState        String? // Estado (ex: São Paulo)
  geoStateCode    String? // Código do estado (ex: SP)
  geoPostalCode   String? // CEP
  geoCountry      String? // País

  // Transcrição
  transcription            String?             @db.Text
  transcriptionLanguage    String?
  transcriptionConfidence  Float?
  transcriptionStatus      TranscriptionStatus @default(pending)
  transcriptionProcessedAt DateTime?
  transcriptionError       String?

  // Status WhatsApp
  status      MessageStatus @default(pending)
  sentAt      DateTime?
  deliveredAt DateTime?
  readAt      DateTime?

  // Concatenação
  isConcatenated Boolean @default(false)
  concatGroupId  String?

  // AI Response Tracking (quando a mensagem é resposta de IA)
  aiModel      String? // gpt-4o, claude-3, etc
  aiAgentId    String? // ID do agente que respondeu
  aiAgentName  String? // Nome do agente
  inputTokens  Int? // Tokens de entrada (prompt)
  outputTokens Int? // Tokens de saída (completion)
  cachedTokens Int? // Tokens em cache (economia)
  inputCost    Float? // Custo dos tokens de entrada
  outputCost   Float? // Custo dos tokens de saída
  cacheSavings Float? // Economia por cache
  totalCost    Float? // Custo total da chamada
  aiLatency    Int? // Latência da resposta em ms
  aiProvider   String? // openai, anthropic, groq, etc

  // Callback/Webhook Origin
  callbackSource  String? // webhook_id ou "n8n", "make", etc
  callbackPayload Json? // Payload original do callback

  // Metadata
  quotedMessageId String?
  isForwarded     Boolean @default(false)
  forwardedInfo   Json?
  metadata        Json? // Metadata adicional flexível

  createdAt DateTime @default(now())

  // Relacionamentos
  session    ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  contact    Contact     @relation(fields: [contactId], references: [id], onDelete: Cascade)
  connection Connection  @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([contactId])
  @@index([connectionId])
  @@index([waMessageId])
  @@index([concatGroupId])
  @@index([transcriptionStatus])
  @@index([aiAgentId])
  @@index([aiModel])
  @@index([createdAt])
}

enum MessageDirection {
  INBOUND // Recebida
  OUTBOUND // Enviada
}

enum MessageType {
  text
  image
  video
  audio
  voice // PTT - Push to Talk
  document
  location
  contact
  sticker
  poll
  list
  buttons
}

enum MessageStatus {
  pending
  sent
  delivered
  read
  failed
}

enum TranscriptionStatus {
  pending // Aguardando processamento
  processing // Em processamento
  completed // Concluída com sucesso
  failed // Falhou
  skipped // Pulada (não aplicável)
}

enum MessageAuthor {
  CUSTOMER // Cliente final
  AGENT // Atendente humano
  AI // IA/Bot
  BUSINESS // Empresa/Sistema
  SYSTEM // Sistema automático
  AGENT_PLATFORM // Plataforma de agente
}

// ============================================
// TABULATIONS (Contact & Session Tags/Labels)
// ============================================

model Tabulation {
  id              String   @id @default(uuid())
  organizationId  String
  name            String
  description     String?
  backgroundColor String   @default("#ffffff")
  labelId         String?  @default("NaN") // Compatibility with falecomigo.ai
  autoTabulation  Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  contactTabulations     ContactTabulation[]
  sessionTabulations     SessionTabulation[]
  tabulationIntegrations TabulationIntegration[]
  tabulationSettings     TabulationSetting[]
  kanbanColumns          KanbanColumn[] // Link Kanban columns to tabulations

  @@index([organizationId])
  @@index([name])
}

model ContactTabulation {
  id           String   @id @default(uuid())
  contactId    String
  tabulationId String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  contact    Contact    @relation(fields: [contactId], references: [id], onDelete: Cascade)
  tabulation Tabulation @relation(fields: [tabulationId], references: [id], onDelete: Cascade)

  @@unique([contactId, tabulationId])
  @@index([contactId])
  @@index([tabulationId])
}

model SessionTabulation {
  id           String   @id @default(uuid())
  sessionId    String
  tabulationId String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now())

  session    ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  tabulation Tabulation  @relation(fields: [tabulationId], references: [id], onDelete: Cascade)

  @@unique([sessionId, tabulationId])
  @@index([sessionId])
  @@index([tabulationId])
}

// ============================================
// TABULATION INTEGRATIONS (Link to Instances)
// ============================================

model TabulationIntegration {
  id           String   @id @default(uuid())
  tabulationId String
  connectionId String
  externalId   String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tabulation Tabulation @relation(fields: [tabulationId], references: [id], onDelete: Cascade)
  connection Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@unique([tabulationId, connectionId])
  @@index([tabulationId])
  @@index([connectionId])
}

model TabulationSetting {
  id           String   @id @default(uuid())
  tabulationId String
  key          String // Setting key (e.g., "webhookUrl", "autoAssign")
  value        String   @db.Text // Setting value (JSON)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tabulation Tabulation @relation(fields: [tabulationId], references: [id], onDelete: Cascade)

  @@unique([tabulationId, key])
  @@index([tabulationId])
}

// ============================================
// ATTRIBUTES (Custom Contact Fields)
// ============================================

model Attribute {
  id             String   @id @default(uuid())
  organizationId String
  name           String // Field name (e.g., "Telefone alternativo")
  description    String?
  type           String // TEXT, DATE, DATETIME, INTEGER, FLOAT, DOCUMENT
  isRequired     Boolean  @default(false)
  defaultValue   String? // Default value for this attribute
  options        Json? // For select/enum types: ["Option 1", "Option 2"]
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  contactAttributes ContactAttribute[]

  @@index([organizationId])
  @@index([type])
  @@index([isActive])
}

model ContactAttribute {
  id          String   @id @default(uuid())
  contactId   String
  attributeId String
  value       String   @db.Text // Stored as string, cast based on Attribute.type
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  contact   Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)
  attribute Attribute @relation(fields: [attributeId], references: [id], onDelete: Cascade)

  @@unique([contactId, attributeId])
  @@index([contactId])
  @@index([attributeId])
}

// ============================================
// KANBAN (Sales & Leads Pipeline)
// ============================================

model KanbanBoard {
  id             String   @id @default(uuid())
  organizationId String
  name           String
  description    String?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  columns KanbanColumn[]

  @@index([organizationId])
  @@index([isActive])
}

model KanbanColumn {
  id              String   @id @default(uuid())
  boardId         String
  name            String
  position        Int // Order position in board
  backgroundColor String   @default("#ffffff")
  tabulationId    String? // Link to Tabulation for auto-assignment
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  board      KanbanBoard @relation(fields: [boardId], references: [id], onDelete: Cascade)
  tabulation Tabulation? @relation(fields: [tabulationId], references: [id], onDelete: SetNull)

  @@index([boardId])
  @@index([position])
  @@index([tabulationId])
}

// ============================================
// LABELS (Category System - Different from Tabulations)
// ============================================

model Label {
  id              String   @id @default(uuid())
  organizationId  String
  name            String
  slug            String
  description     String?
  backgroundColor String   @default("#ffffff")
  icon            String? // Icon name or emoji
  category        String? // Category grouping
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([organizationId, slug])
  @@index([organizationId])
  @@index([category])
  @@index([isActive])
}

// ============================================
// CONTACT OBSERVATIONS (Notes for Contacts)
// ============================================

model ContactObservation {
  id        String   @id @default(uuid())
  contactId String
  userId    String // Author of observation
  content   String   @db.Text
  type      String   @default("note") // note, warning, important
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  contact Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id])

  @@index([contactId])
  @@index([userId])
  @@index([type])
  @@index([createdAt])
}

// ============================================
// FILES (File Management & Storage)
// ============================================

model File {
  id             String   @id @default(uuid())
  organizationId String
  userId         String // Uploader
  fileName       String
  fileSize       Int // Bytes
  mimeType       String
  url            String // S3/CDN URL or local path
  thumbnail      String? // Thumbnail URL for images/videos
  metadata       Json? // Additional metadata (dimensions, duration, etc)
  createdAt      DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([organizationId])
  @@index([userId])
  @@index([mimeType])
  @@index([createdAt])
}

// ============================================
// CALLS (WhatsApp Call Management)
// ============================================

model Call {
  id             String @id @default(uuid())
  connectionId   String
  contactId      String
  organizationId String

  // Call details
  direction   CallDirection
  status      CallStatus    @default(INITIATED)
  externalId  String?       @unique
  initiatedBy String?

  // Timestamps
  startedAt  DateTime  @default(now())
  answeredAt DateTime?
  endedAt    DateTime?
  duration   Int?

  // Metadata
  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  connection   Connection   @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  contact      Contact      @relation(fields: [contactId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User?        @relation(fields: [initiatedBy], references: [id], onDelete: SetNull)

  @@index([connectionId])
  @@index([contactId])
  @@index([organizationId])
  @@index([initiatedBy])
  @@index([status])
  @@index([direction])
  @@index([externalId])
  @@index([startedAt])
}

enum CallDirection {
  INCOMING // Chamada recebida
  OUTGOING // Chamada feita
}

enum CallStatus {
  INITIATED // Chamada iniciada
  RINGING // Tocando
  ANSWERED // Atendida
  MISSED // Perdida
  REJECTED // Rejeitada
  BUSY // Ocupado
  FAILED // Falhou
  ENDED // Finalizada
}

// ============================================
// INTEGRATION CONFIGURATIONS (Provider Settings)
// ============================================

model IntegrationConfig {
  id             String          @id @default(uuid())
  organizationId String
  type           IntegrationType
  name           String
  isActive       Boolean         @default(true)
  isDefault      Boolean         @default(false)

  // Encrypted credentials (use encryption at app level)
  apiKey        String?
  apiSecret     String?
  apiUrl        String?
  webhookUrl    String?
  webhookSecret String?

  // Additional settings as JSON
  settings Json?
  metadata Json?

  // Rate limiting
  rateLimit       Int?
  rateLimitPeriod Int? // in seconds

  // Health check
  lastHealthCheck DateTime?
  healthStatus    String?   @default("unknown")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, type, name])
  @@index([organizationId])
  @@index([type])
  @@index([isActive])
}

enum IntegrationType {
  // AI Providers
  OPENAI
  ANTHROPIC
  GROQ
  TOGETHER_AI
  OLLAMA

  // Transcription Providers
  DEEPGRAM
  WHISPER_API
  ASSEMBLY_AI

  // Storage Providers
  SUPABASE
  AWS_S3
  CLOUDFLARE_R2

  // Database Providers
  POSTGRESQL
  REDIS
  MONGODB

  // Messaging Channels
  UAZAPI
  CHATWOOT
  WHATSAPP_CLOUD
  TELEGRAM
  MESSENGER

  // Other
  CUSTOM
}

// ============================================
// PROVIDER CATEGORY (BYOC Architecture)
// ============================================

enum ProviderCategory {
  AI // LLMs: openai, anthropic, google, openrouter
  TRANSCRIPTION // STT: whisper, deepgram, assemblyai
  TTS // Text-to-Speech: elevenlabs, openai-tts
  INFRASTRUCTURE // redis, postgresql, supabase, s3
  AUXILIARY // google-maps, email, sms
}

// ============================================
// ORGANIZATION PROVIDER (BYOC Credentials)
// ============================================

model OrganizationProvider {
  id             String @id @default(uuid())
  organizationId String

  // Tipo do provedor
  category ProviderCategory
  provider String // openai, anthropic, redis, supabase, etc

  // Configuração
  isActive  Boolean @default(true)
  isPrimary Boolean @default(false) // Provedor principal da categoria
  priority  Int     @default(0) // Para fallback ordering (menor = maior prioridade)

  // Credenciais (encriptadas no nível da aplicação)
  credentials Json // { apiKey, apiSecret, apiUrl, region, bucket, etc }

  // Configurações específicas do provedor
  settings Json? // { model: "gpt-4o", maxTokens: 4096, temperature: 0.7, etc }

  // Metadados de uso
  lastTestedAt   DateTime?
  lastTestStatus String? // success, failed, pending
  lastTestError  String?
  usageThisMonth Int       @default(0) // Para tracking de uso
  costThisMonth  Float     @default(0) // Custo estimado do mês

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, category, provider, priority])
  @@index([organizationId, category])
  @@index([organizationId, isActive])
  @@index([category, provider])
  @@map("organization_providers")
}

// Configurations at system/admin level (global defaults)
model SystemConfig {
  id          String  @id @default(uuid())
  key         String  @unique
  value       String
  type        String  @default("string") // string, number, boolean, json
  category    String  @default("general")
  description String?
  isEncrypted Boolean @default(false)
  isEditable  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([key])
}

// AI Agent Configuration per Organization
model AIAgentConfig {
  id             String  @id @default(uuid())
  organizationId String
  name           String
  isActive       Boolean @default(true)

  // Model settings
  provider    String @default("openai") // openai, anthropic, groq
  model       String @default("gpt-4o")
  temperature Float  @default(0.7)
  maxTokens   Int    @default(4096)

  // System prompt
  systemPrompt String? @db.Text
  personality  String?

  // Agent Identity (para tracking e analytics)
  agentTarget   String? // "vendas", "suporte", "atendimento"
  agentBehavior String? // Comportamento padrão
  agentAvatar   String? // URL do avatar

  // Memory settings
  useMemory    Boolean @default(true)
  memoryWindow Int     @default(10) // Number of messages to remember

  // RAG settings
  useRAG          Boolean @default(false)
  ragCollectionId String?

  // Tool settings
  enabledTools String[] @default([])

  // TTS Settings (Text-to-Speech)
  enableTTS     Boolean @default(false)
  ttsProvider   String? // "elevenlabs", "openai", "google"
  ttsVoiceId    String? // ID da voz (ex: ElevenLabs voice ID)
  ttsModel      String? // Modelo TTS
  ttsSpeechRate Float?  @default(1.0) // Velocidade da fala

  // Callback settings
  callbackUrl    String?
  callbackSecret String?

  // Cost tracking (agregado por agente)
  totalInputTokens  Int   @default(0)
  totalOutputTokens Int   @default(0)
  totalCachedTokens Int   @default(0)
  totalCost         Float @default(0)
  totalCacheSavings Float @default(0)
  totalCalls        Int   @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  sessions   ChatSession[]
  groupChats GroupChat[] // Grupos que usam este agente IA

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([isActive])
}

// ============================================
// SYSTEM SETTINGS (Global Platform Config)
// ============================================

model SystemSettings {
  id        String  @id @default(uuid())
  category  String // uazapi, email, ai, concatenation, oauth, security, system
  key       String // setting key within category
  value     String  @db.Text // setting value (JSON for complex values)
  encrypted Boolean @default(false) // whether value is encrypted

  description String? // human-readable description

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  updatedBy String? // user id who last updated

  @@unique([category, key])
  @@index([category])
}

// Email Templates (customizable by admin)
model EmailTemplate {
  id          String   @id @default(uuid())
  name        String   @unique // welcome, verification, reset_password, invitation
  subject     String
  htmlContent String   @db.Text
  textContent String?  @db.Text
  variables   String[] // available variables like {{name}}, {{link}}
  isActive    Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  updatedBy String?

  @@index([name])
}

// AI Prompts (customizable by admin)
model AIPrompt {
  id          String  @id @default(uuid())
  name        String  @unique // image_description, audio_transcription, text_analysis
  description String?
  prompt      String  @db.Text
  model       String? // gpt-4-vision, whisper-1, etc
  isActive    Boolean @default(true)

  // Usage tracking
  usageCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  updatedBy String?

  @@index([name])
}

// ============================================
// API KEYS (Programmatic API Access)
// ============================================

model ApiKey {
  id   String @id @default(uuid())
  name String // User-friendly name (e.g., "Production Server", "CI/CD Pipeline")

  // Key Storage (never store plain text)
  keyHash String @unique // SHA-256 hash of the full key
  prefix  String // First 8 chars for display (e.g., "qk_live_a")

  // Ownership
  organizationId String
  userId         String // Creator of the key

  // Permissions & Scope
  scopes String[] @default(["read"]) // read, write, admin, webhooks, instances, etc

  // Expiration (null = never expires)
  expiresAt DateTime?

  // Usage Tracking
  lastUsedAt DateTime?
  lastUsedIp String?
  usageCount Int       @default(0)

  // Status
  isActive  Boolean   @default(true)
  revokedAt DateTime?
  revokedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([userId])
  @@index([prefix])
  @@index([isActive])
  @@index([expiresAt])
  @@map("api_keys")
}

// ============================================
// SYSTEM LOGS (Real-time Logging & AI Analysis)
// ============================================

model LogEntry {
  id        String   @id @default(uuid())
  timestamp DateTime @default(now())

  // Log Classification
  level  LogLevel @default(INFO)
  source String // auth, webhook, api, database, whatsapp, ai, system
  action String? // login, message.received, webhook.failed, etc

  // Content
  message    String  @db.Text
  details    String? @db.Text // Detailed description
  stackTrace String? @db.Text

  // Context (JSON)
  context  Json? // { userId, orgId, connectionId, sessionId, requestId, etc }
  metadata Json? // Additional metadata

  // Request tracking
  requestId     String? // For request correlation
  requestPath   String? // /api/v1/auth/login
  requestMethod String? // GET, POST, etc
  statusCode    Int? // HTTP status code
  duration      Int? // Request duration in ms

  // User context
  userId         String?
  organizationId String?
  connectionId   String?
  sessionId      String?
  ipAddress      String?
  userAgent      String?

  // AI Analysis
  aiAnalysis     String?   @db.Text // AI-generated analysis
  aiAnalyzedAt   DateTime?
  aiPatternMatch String? // Detected pattern type
  aiSeverity     Int?      @default(0) // 0-10 severity score
  aiSuggestion   String?   @db.Text // AI suggestion for fix

  // Tags for filtering
  tags String[] @default([])

  // Indexes
  @@index([timestamp])
  @@index([level])
  @@index([source])
  @@index([userId])
  @@index([organizationId])
  @@index([connectionId])
  @@index([sessionId])
  @@index([requestId])
  @@index([aiPatternMatch])
  @@index([aiSeverity])
  @@map("log_entries")
}

enum LogLevel {
  DEBUG
  INFO
  WARN
  ERROR
  CRITICAL
}

// AI Log Analysis Results (cached analyses)
model LogAnalysis {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  // Time range analyzed
  periodStart DateTime
  periodEnd   DateTime

  // Analysis type
  type String // hourly, daily, realtime, pattern

  // Results
  summary     String @db.Text // Human-readable summary
  patterns    Json // Detected patterns
  anomalies   Json // Detected anomalies
  suggestions Json // AI suggestions
  metrics     Json // Key metrics
  severity    Int    @default(0) // 0-10

  // Model info
  aiModel   String? // gpt-4o, claude-3, etc
  aiTokens  Int?
  aiCost    Float?
  aiLatency Int? // ms

  @@index([createdAt])
  @@index([type])
  @@index([periodStart, periodEnd])
  @@map("log_analyses")
}

// ============================================
// NOTIFICATIONS (User & System Notifications)
// ============================================

model Notification {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Target (who receives the notification)
  userId         String? // Specific user
  organizationId String? // All users in organization
  role           String? // All users with role (admin, master, manager, etc)
  isGlobal       Boolean @default(false) // All users

  // Content
  type        NotificationType
  title       String
  description String           @db.Text
  actionUrl   String? // URL to navigate on click
  actionLabel String? // Button label (e.g., "Ver detalhes")

  // Metadata
  source   String? // auth, webhook, message, system, instance, etc
  sourceId String? // ID of related entity
  metadata Json? // Additional context data

  // Scheduling
  scheduledFor DateTime? // Future notification
  expiresAt    DateTime? // Auto-delete after

  // Status
  isActive Boolean @default(true)

  // Relations
  reads NotificationRead[]

  // Indexes
  @@index([userId])
  @@index([organizationId])
  @@index([role])
  @@index([type])
  @@index([isGlobal])
  @@index([createdAt])
  @@index([scheduledFor])
  @@index([expiresAt])
  @@map("notifications")
}

// User's read status for notifications
model NotificationRead {
  id             String   @id @default(uuid())
  notificationId String
  userId         String
  readAt         DateTime @default(now())

  notification Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  @@unique([notificationId, userId])
  @@index([userId])
  @@index([notificationId])
  @@map("notification_reads")
}

enum NotificationType {
  MESSAGE // Nova mensagem
  USER // Relacionado a usuários
  WARNING // Alerta/Aviso
  INFO // Informativo
  SUCCESS // Sucesso/Confirmação
  ERROR // Erro
  SYSTEM // Sistema
  CONNECTION // Status de conexão
}
