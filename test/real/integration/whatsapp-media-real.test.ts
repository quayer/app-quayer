import { describe, it, expect, beforeAll, afterAll } from 'vitest'
import { setupRealDatabase, cleanupRealDatabase, getRealPrisma } from '../setup/database'
import { validateRealTestEnv } from '../setup/env-validator'
import { askPhoneNumber, askUser, displayQRCode, waitForUserAction, confirmAction, showMenu } from '../setup/interactive'
import fs from 'fs'
import path from 'path'

/**
 * üì± TESTE REAL DE WHATSAPP COM M√çDIA
 *
 * Este teste:
 * - Conecta WhatsApp via QR Code REAL
 * - Envia IMAGEM real
 * - Envia √ÅUDIO real
 * - Envia V√çDEO real
 * - Envia DOCUMENTO real
 * - Valida entrega e status no banco
 * - Testa stack completo: API ‚Üí UAZAPI ‚Üí WhatsApp ‚Üí Prisma
 */
describe('üì± WhatsApp M√≠dia REAL', () => {
  let env: ReturnType<typeof validateRealTestEnv>
  let instanceId: string
  let instanceName: string
  let accessToken: string
  let testPhoneNumber: string

  beforeAll(async () => {
    console.log('\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó')
    console.log('‚ïë   TESTE REAL: WHATSAPP COM ENVIO DE M√çDIA           ‚ïë')
    console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n')

    env = validateRealTestEnv()
    await setupRealDatabase()

    // Login
    console.log('üîê Fazendo login...\n')
    const baseUrl = env.NEXT_PUBLIC_APP_URL
    const loginResponse = await fetch(`${baseUrl}/api/v1/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: 'admin@quayer.com',
        password: 'admin123456',
      }),
    })

    const loginData = await loginResponse.json()
    accessToken = loginData.data.accessToken
    console.log('‚úÖ Token obtido\n')
  })

  afterAll(async () => {
    // Cleanup
    if (instanceId) {
      const baseUrl = env.NEXT_PUBLIC_APP_URL
      await fetch(`${baseUrl}/api/v1/instances/${instanceId}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${accessToken}` },
      }).catch(() => {})
    }
    await cleanupRealDatabase()
  })

  it('deve criar e conectar inst√¢ncia WhatsApp', async () => {
    console.log('\nüì± PASSO 1: Criar e Conectar WhatsApp\n')

    instanceName = `test_media_${Date.now()}`
    const baseUrl = env.NEXT_PUBLIC_APP_URL

    // Criar inst√¢ncia
    const createResponse = await fetch(`${baseUrl}/api/v1/instances`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        instanceName,
        provider: 'uazapi',
      }),
    })

    const createData = await createResponse.json()
    instanceId = createData.data.id

    console.log('‚úÖ Inst√¢ncia criada!')

    // Obter QR Code
    const qrResponse = await fetch(`${baseUrl}/api/v1/instances/${instanceId}/qrcode`, {
      headers: { 'Authorization': `Bearer ${accessToken}` },
    })

    const qrData = await qrResponse.json()
    displayQRCode(qrData.data.qrCode)

    console.log('üì± INSTRU√á√ïES:')
    console.log('   1. Abra WhatsApp no celular')
    console.log('   2. Menu > Aparelhos conectados')
    console.log('   3. Conectar aparelho')
    console.log('   4. Escaneie o QR Code\n')

    await waitForUserAction('Escaneie o QR Code')

    // Polling
    let connected = false
    let attempts = 0
    while (!connected && attempts < 30) {
      const statusResponse = await fetch(`${baseUrl}/api/v1/instances/${instanceId}/status`, {
        headers: { 'Authorization': `Bearer ${accessToken}` },
      })
      const statusData = await statusResponse.json()

      if (statusData.data.status === 'connected') {
        connected = true
        console.log('\n‚úÖ WhatsApp conectado!')
        break
      }

      process.stdout.write(`\r‚è≥ Aguardando conex√£o... ${attempts + 1}/30`)
      await new Promise(resolve => setTimeout(resolve, 2000))
      attempts++
    }

    expect(connected).toBe(true)

    testPhoneNumber = await askPhoneNumber('üìû Digite n√∫mero para receber m√≠dias:')
  })

  it('deve enviar IMAGEM real', async () => {
    console.log('\nüñºÔ∏è  PASSO 2: Enviar Imagem\n')

    const baseUrl = env.NEXT_PUBLIC_APP_URL

    // Op√ß√µes para imagem
    const choice = await showMenu('Escolha a fonte da imagem:', [
      'URL de imagem p√∫blica',
      'Arquivo local (path)',
      'Base64 embutido',
    ])

    let imageUrl: string
    let caption = 'üñºÔ∏è  Imagem de teste autom√°tico'

    if (choice === 1) {
      imageUrl = await askUser('üîó Digite URL da imagem:')
    } else if (choice === 2) {
      const filePath = await askUser('üìÅ Digite path do arquivo:')
      // Simular upload (em produ√ß√£o, usaria S3 ou similar)
      imageUrl = `file://${filePath}`
      console.log('‚ö†Ô∏è  Nota: Em produ√ß√£o, fazer upload para S3/storage p√∫blico')
    } else {
      // Imagem de teste padr√£o (1x1 px transparente PNG)
      imageUrl = 'https://via.placeholder.com/300x300.png?text=Teste+Automatico'
    }

    console.log(`\n‚è≥ Enviando imagem para ${testPhoneNumber}...`)

    const sendResponse = await fetch(`${baseUrl}/api/v1/messages/send-media`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        instanceId,
        to: testPhoneNumber,
        mediaUrl: imageUrl,
        mediaType: 'image',
        caption,
      }),
    })

    const sendData = await sendResponse.json()

    expect(sendResponse.status).toBe(200)
    expect(sendData.data.messageId).toBeDefined()

    const messageId = sendData.data.messageId

    console.log('\n‚úÖ Imagem enviada!')
    console.log(`   Message ID: ${messageId}`)

    // Validar no banco
    const prisma = getRealPrisma()
    const message = await prisma.message.findUnique({
      where: { id: messageId },
    })

    expect(message).toBeTruthy()
    expect(message?.type).toBe('image')
    expect(message?.mediaUrl).toBe(imageUrl)

    console.log('‚úÖ Mensagem validada no banco!')

    // Confirmar recebimento
    const received = await confirmAction('Voc√™ recebeu a IMAGEM?')
    expect(received).toBe(true)
  })

  it('deve enviar √ÅUDIO real', async () => {
    console.log('\nüéµ PASSO 3: Enviar √Åudio\n')

    const baseUrl = env.NEXT_PUBLIC_APP_URL

    const audioUrl = await askUser('üîó Digite URL do arquivo de √°udio (MP3/OGG):')

    console.log(`\n‚è≥ Enviando √°udio para ${testPhoneNumber}...`)

    const sendResponse = await fetch(`${baseUrl}/api/v1/messages/send-media`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        instanceId,
        to: testPhoneNumber,
        mediaUrl: audioUrl,
        mediaType: 'audio',
      }),
    })

    const sendData = await sendResponse.json()

    expect(sendResponse.status).toBe(200)

    const messageId = sendData.data.messageId

    console.log('\n‚úÖ √Åudio enviado!')
    console.log(`   Message ID: ${messageId}`)

    // Validar no banco
    const prisma = getRealPrisma()
    const message = await prisma.message.findUnique({
      where: { id: messageId },
    })

    expect(message?.type).toBe('audio')

    console.log('‚úÖ Validado no banco!')

    const received = await confirmAction('Voc√™ recebeu o √ÅUDIO?')
    expect(received).toBe(true)
  })

  it('deve enviar V√çDEO real', async () => {
    console.log('\nüé¨ PASSO 4: Enviar V√≠deo\n')

    const baseUrl = env.NEXT_PUBLIC_APP_URL

    const videoUrl = await askUser('üîó Digite URL do v√≠deo (MP4):')
    const caption = 'üé¨ V√≠deo de teste autom√°tico'

    console.log(`\n‚è≥ Enviando v√≠deo para ${testPhoneNumber}...`)

    const sendResponse = await fetch(`${baseUrl}/api/v1/messages/send-media`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        instanceId,
        to: testPhoneNumber,
        mediaUrl: videoUrl,
        mediaType: 'video',
        caption,
      }),
    })

    const sendData = await sendResponse.json()

    expect(sendResponse.status).toBe(200)

    const messageId = sendData.data.messageId

    console.log('\n‚úÖ V√≠deo enviado!')
    console.log(`   Message ID: ${messageId}`)

    // Validar no banco
    const prisma = getRealPrisma()
    const message = await prisma.message.findUnique({
      where: { id: messageId },
    })

    expect(message?.type).toBe('video')

    console.log('‚úÖ Validado no banco!')

    const received = await confirmAction('Voc√™ recebeu o V√çDEO?')
    expect(received).toBe(true)
  })

  it('deve enviar DOCUMENTO real', async () => {
    console.log('\nüìÑ PASSO 5: Enviar Documento\n')

    const baseUrl = env.NEXT_PUBLIC_APP_URL

    const documentUrl = await askUser('üîó Digite URL do documento (PDF, DOC, etc):')
    const fileName = await askUser('üìù Digite nome do arquivo:')

    console.log(`\n‚è≥ Enviando documento para ${testPhoneNumber}...`)

    const sendResponse = await fetch(`${baseUrl}/api/v1/messages/send-media`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        instanceId,
        to: testPhoneNumber,
        mediaUrl: documentUrl,
        mediaType: 'document',
        fileName,
      }),
    })

    const sendData = await sendResponse.json()

    expect(sendResponse.status).toBe(200)

    const messageId = sendData.data.messageId

    console.log('\n‚úÖ Documento enviado!')
    console.log(`   Message ID: ${messageId}`)
    console.log(`   Arquivo: ${fileName}`)

    // Validar no banco
    const prisma = getRealPrisma()
    const message = await prisma.message.findUnique({
      where: { id: messageId },
    })

    expect(message?.type).toBe('document')

    console.log('‚úÖ Validado no banco!')

    const received = await confirmAction('Voc√™ recebeu o DOCUMENTO?')
    expect(received).toBe(true)
  })

  it('deve validar status de entrega', async () => {
    console.log('\n‚úÖ PASSO 6: Validar Status de Entrega\n')

    const baseUrl = env.NEXT_PUBLIC_APP_URL

    // Listar mensagens da inst√¢ncia
    const listResponse = await fetch(
      `${baseUrl}/api/v1/messages?instanceId=${instanceId}&limit=10`,
      {
        headers: { 'Authorization': `Bearer ${accessToken}` },
      }
    )

    const listData = await listResponse.json()

    expect(listResponse.status).toBe(200)
    expect(listData.data.length).toBeGreaterThan(0)

    console.log(`\nüìä Mensagens enviadas: ${listData.data.length}`)

    listData.data.forEach((msg: any) => {
      console.log(`   - ${msg.type}: ${msg.status} (${msg.to})`)
    })

    console.log('\n‚úÖ Status validado!')

    console.log('\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó')
    console.log('‚ïë   TESTE COMPLETO: WHATSAPP M√çDIA 100% REAL          ‚ïë')
    console.log('‚ïë   ‚úÖ WhatsApp conectado via QR Code                   ‚ïë')
    console.log('‚ïë   ‚úÖ Imagem enviada e recebida                        ‚ïë')
    console.log('‚ïë   ‚úÖ √Åudio enviado e recebido                         ‚ïë')
    console.log('‚ïë   ‚úÖ V√≠deo enviado e recebido                         ‚ïë')
    console.log('‚ïë   ‚úÖ Documento enviado e recebido                     ‚ïë')
    console.log('‚ïë   ‚úÖ Status validado no banco                         ‚ïë')
    console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n')
  })
})
