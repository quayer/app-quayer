name: Production Deploy

on:
  push:
    branches:
      - main
  release:
    types: [published]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Production
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: 22
          script: |
            set -e # Falha o script se qualquer comando falhar
            
            # Diret√≥rio da aplica√ß√£o
            APP_DIR="/opt/quayer"
            
            echo "üî• Iniciando Deploy Brutal..."
            
            # Verificar se o diret√≥rio existe e √© um reposit√≥rio git
            if [ ! -d "$APP_DIR/.git" ]; then
              echo "‚ö†Ô∏è Reposit√≥rio n√£o encontrado ou inv√°lido. Refazendo clone..."
              rm -rf "$APP_DIR"
              mkdir -p "$APP_DIR"
              git clone https://github.com/quayer/app-quayer.git "$APP_DIR"
              cd "$APP_DIR"
            else
              cd "$APP_DIR"
              echo "‚úÖ Reposit√≥rio encontrado. Resetando estado..."
              git fetch --all
              git reset --hard origin/main
            fi
            
            # Limpeza garantindo que .env seja PRESERVADO
            # -f: force, -d: directories, -X: ignored files (N√ÉO usar -X ou -x para manter .env se estiver ignorado)
            # -e .env: exclude from cleaning specifically
            git clean -fd -e .env
            
            # Garantir que estamos na main atualizada
            git checkout main
            git pull origin main
            
            echo "üèóÔ∏è Construindo containers..."
            # Parar app antes do build para liberar mem√≥ria
            docker-compose -f docker-compose.prod.yml stop app || true
            
            # Build sem cache para garantir
            docker-compose -f docker-compose.prod.yml build --no-cache app
            
            echo "üöÄ Subindo aplica√ß√£o..."
            docker-compose -f docker-compose.prod.yml up -d --force-recreate app
            
            echo "üßπ Limpando imagens antigas..."
            docker image prune -f
            
            echo "‚úÖ Deploy conclu√≠do com sucesso!"
