name: Production Deploy

on:
  push:
    branches:
      - main
  release:
    types: [published]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Production
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: 22
          script: |
            set -e # Falha o script se qualquer comando falhar

            # DiretÃ³rio da aplicaÃ§Ã£o
            APP_DIR="/opt/quayer"

            # Arquivo compose para coexistir com Supabase
            COMPOSE_FILE="docker-compose.quayer.yml"

            echo "ğŸ”¥ Iniciando Deploy Quayer..."

            # Verificar se o diretÃ³rio existe e Ã© um repositÃ³rio git
            if [ ! -d "$APP_DIR/.git" ]; then
              echo "âš ï¸ RepositÃ³rio nÃ£o encontrado ou invÃ¡lido. Refazendo clone..."
              rm -rf "$APP_DIR"
              mkdir -p "$APP_DIR"
              git clone https://github.com/quayer/app-quayer.git "$APP_DIR"
              cd "$APP_DIR"
            else
              cd "$APP_DIR"
              echo "âœ… RepositÃ³rio encontrado. Resetando estado..."
              git fetch --all
              git reset --hard origin/main
            fi

            # Limpeza garantindo que .env seja PRESERVADO
            git clean -fd -e .env

            # Garantir que estamos na main atualizada
            git checkout main
            git pull origin main

            # Verificar se .env existe
            if [ -f .env ]; then
              echo "âœ… Arquivo .env encontrado. Carregando variÃ¡veis..."
              set -a
              source .env
              set +a
            else
              echo "âŒ ERRO: Arquivo .env NÃƒO encontrado!"
              echo "Configure o .env no servidor antes do deploy."
              exit 1
            fi

            # Verificar se rede supabase_default existe
            if ! docker network inspect supabase_default &> /dev/null; then
              echo "âš ï¸ Rede supabase_default nÃ£o existe. Criando..."
              docker network create supabase_default || true
            fi

            # Priorizar docker compose v2
            if docker compose version &> /dev/null; then
              COMPOSE_CMD="docker compose"
              echo "âœ… Usando Docker Compose v2 (Plugin)"
            elif command -v docker-compose &> /dev/null; then
              COMPOSE_CMD="docker-compose"
              echo "âš ï¸ Usando Docker Compose v1 (Legacy)"
            else
              echo "âŒ Docker Compose nÃ£o encontrado!"
              exit 1
            fi

            echo "ğŸ³ Usando: $COMPOSE_CMD -f $COMPOSE_FILE"

            echo "ğŸ§¹ Limpeza PrÃ©-Build..."
            docker system prune -f || true

            echo "ğŸ”¥ Parando containers antigos..."
            $COMPOSE_CMD -f $COMPOSE_FILE down --remove-orphans || true

            echo "ğŸ—ï¸ Construindo imagem..."
            $COMPOSE_CMD -f $COMPOSE_FILE build --no-cache app

            echo "ğŸš€ Subindo aplicaÃ§Ã£o..."
            $COMPOSE_CMD -f $COMPOSE_FILE up -d --force-recreate

            echo "â³ Aguardando health check..."
            sleep 30

            # Verificar se app estÃ¡ healthy
            if docker inspect quayer-app --format='{{.State.Health.Status}}' 2>/dev/null | grep -q "healthy"; then
              echo "âœ… App estÃ¡ healthy!"
            else
              echo "âš ï¸ App ainda nÃ£o estÃ¡ healthy, verificando logs..."
              docker logs quayer-app --tail 20
            fi

            echo "ğŸ§¹ Limpando imagens antigas..."
            docker image prune -f || true

            echo "âœ… Deploy concluÃ­do com sucesso!"
            echo "ğŸŒ App disponÃ­vel em: https://app.quayer.com"
