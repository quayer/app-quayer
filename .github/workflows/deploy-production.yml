name: Production Deploy

on:
  push:
    branches:
      - main
  release:
    types: [published]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Production
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: 22
          script: |
            set -e # Falha o script se qualquer comando falhar
            
            # DiretÃ³rio da aplicaÃ§Ã£o
            APP_DIR="/opt/quayer"
            
            echo "ğŸ”¥ Iniciando Deploy Brutal..."
            
            # Verificar se o diretÃ³rio existe e Ã© um repositÃ³rio git
            if [ ! -d "$APP_DIR/.git" ]; then
              echo "âš ï¸ RepositÃ³rio nÃ£o encontrado ou invÃ¡lido. Refazendo clone..."
              rm -rf "$APP_DIR"
              mkdir -p "$APP_DIR"
              git clone https://github.com/quayer/app-quayer.git "$APP_DIR"
              cd "$APP_DIR"
            else
              cd "$APP_DIR"
              echo "âœ… RepositÃ³rio encontrado. Resetando estado..."
              git fetch --all
              git reset --hard origin/main
            fi
            
            # Limpeza garantindo que .env seja PRESERVADO
            # -f: force, -d: directories, -X: ignored files (NÃƒO usar -X ou -x para manter .env se estiver ignorado)
            # -e .env: exclude from cleaning specifically
            git clean -fd -e .env
            
            # Garantir que estamos na main atualizada
            git checkout main
            git pull origin main
            
            # Detectar comando do Docker Compose
            if command -v docker-compose &> /dev/null; then
              COMPOSE_CMD="docker-compose"
            else
              COMPOSE_CMD="docker compose"
            fi
            
            echo "ğŸ³ Usando comando: $COMPOSE_CMD"
            
            echo "ğŸ—ï¸ Construindo containers..."
            # Parar app antes do build para liberar memÃ³ria
            $COMPOSE_CMD -f docker-compose.prod.yml stop app || true
            
            # Build sem cache para garantir
            $COMPOSE_CMD -f docker-compose.prod.yml build --no-cache app
            
            echo "ğŸš€ Subindo aplicaÃ§Ã£o..."
            $COMPOSE_CMD -f docker-compose.prod.yml up -d --force-recreate app
            
            echo "ğŸ§¹ Limpando imagens antigas..."
            docker image prune -f || true
            
            echo "âœ… Deploy concluÃ­do com sucesso!"
