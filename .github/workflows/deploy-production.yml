name: Production Deploy

on:
  push:
    branches:
      - main
  release:
    types: [published]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Production
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: 22
          script: |
            set -e # Falha o script se qualquer comando falhar
            cd /opt/quayer
            
            echo "üî• Iniciando Deploy Brutal..."
            
            # Reset total do reposit√≥rio para evitar conflitos
            git fetch --all
            git reset --hard origin/main
            git clean -fd
            
            # Garantir que estamos na main atualizada
            git checkout main
            git pull origin main
            
            echo "üèóÔ∏è Construindo containers..."
            # For√ßar recria√ß√£o para garantir que mudan√ßas de c√≥digo entrem
            docker-compose -f docker-compose.prod.yml stop app || true
            docker-compose -f docker-compose.prod.yml build --no-cache app
            
            echo "üöÄ Subindo aplica√ß√£o..."
            docker-compose -f docker-compose.prod.yml up -d --force-recreate app
            
            echo "üßπ Limpando..."
            docker image prune -f
            
            echo "‚úÖ Deploy conclu√≠do com sucesso!"
