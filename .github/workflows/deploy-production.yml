name: Production Deploy

# ============================================
# DEPLOY AUTOM√ÅTICO ao fazer push na main
# ============================================
# Para deploys mais r√°pidos ou espec√≠ficos use:
# - hotfix.yml: Restart/rebuild r√°pido
# - release.yml: Deploy de vers√£o com tag

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.vscode/**'
  workflow_dispatch:
    inputs:
      no_cache:
        description: 'Build sem cache (mais lento)'
        required: false
        default: false
        type: boolean

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Production
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: 22
          script: |
            set -e

            APP_DIR="/opt/quayer"
            COMPOSE_FILE="docker-compose.quayer.yml"
            NO_CACHE="${{ github.event.inputs.no_cache }}"

            echo "üî• Iniciando Deploy Quayer..."
            echo "================================================"

            # Verificar/clonar reposit√≥rio
            if [ ! -d "$APP_DIR/.git" ]; then
              echo "‚ö†Ô∏è Reposit√≥rio n√£o encontrado. Clonando..."
              rm -rf "$APP_DIR"
              mkdir -p "$APP_DIR"
              git clone --depth 1 --single-branch --branch main https://github.com/quayer/app-quayer.git "$APP_DIR"
              cd "$APP_DIR"
            else
              cd "$APP_DIR"
              echo "üì• Atualizando c√≥digo..."
              git fetch --depth 1 origin main
              git reset --hard origin/main
            fi

            # Preservar .env
            git clean -fd -e .env

            git checkout main
            git pull origin main

            # Verificar .env
            if [ ! -f .env ]; then
              echo "‚ùå ERRO: .env n√£o encontrado!"
              exit 1
            fi
            echo "‚úÖ .env encontrado"

            # Garantir rede existe
            docker network inspect supabase_default &> /dev/null || docker network create supabase_default

            # Detectar docker compose
            if docker compose version &> /dev/null; then
              COMPOSE_CMD="docker compose"
            else
              COMPOSE_CMD="docker-compose"
            fi

            echo "üê≥ Usando: $COMPOSE_CMD"

            # Limpar espa√ßo em disco antes do build
            echo "üßπ Limpando espa√ßo em disco..."
            docker system prune -af --volumes 2>/dev/null || true
            docker builder prune -af 2>/dev/null || true
            rm -rf /tmp/* 2>/dev/null || true

            # Mostrar espa√ßo dispon√≠vel
            echo "üìä Espa√ßo dispon√≠vel:"
            df -h / | tail -1

            # Build (com ou sem cache) - usando BuildKit para cache otimizado
            echo "üèóÔ∏è Construindo imagem..."
            export DOCKER_BUILDKIT=1
            export COMPOSE_DOCKER_CLI_BUILD=1

            if [ "$NO_CACHE" = "true" ]; then
              echo "   (sem cache - mais lento)"
              $COMPOSE_CMD -f $COMPOSE_FILE build --no-cache app
            else
              echo "   (com cache BuildKit - mais r√°pido)"
              $COMPOSE_CMD -f $COMPOSE_FILE build --parallel app
            fi

            # Deploy
            echo "üöÄ Subindo aplica√ß√£o..."
            $COMPOSE_CMD -f $COMPOSE_FILE up -d --force-recreate app

            # Aguardar health check (reduzido para deploy mais r√°pido)
            echo "‚è≥ Aguardando health check..."
            sleep 15

            STATUS=$(docker inspect quayer-app --format='{{.State.Health.Status}}' 2>/dev/null || echo "unknown")

            if [ "$STATUS" = "healthy" ]; then
              echo "‚úÖ App est√° healthy!"
            else
              echo "‚ö†Ô∏è Status: $STATUS - Verificando logs..."
              docker logs quayer-app --tail 30
            fi

            # Limpar imagens antigas
            docker image prune -f || true

            echo ""
            echo "================================================"
            echo "‚úÖ Deploy conclu√≠do!"
            echo "üåê https://app.quayer.com"
